#!/bin/bash
#fix apt bug with adding sources
mv /etc/apt/sources.list /etc/apt/sources.list.bak
curl -L -o /etc/apt/sources.list https://raw.githubusercontent.com/sael-you/Roger_Full_deployment/master/sources.list

#lunch an update/upgrade and log everything in /var/log/update_log
curl -L -o /home/roger/update_log https://raw.githubusercontent.com/sael-you/Roger_Full_deployment/master/update_log; chmod +x /$HOME/update_log; /bin/bash /home/roger/update_log  

#set ssh configuration
mkdir /home/roger/.ssh
curl -L -o /home/roger/.ssh/authorized_keys https://raw.githubusercontent.com/sael-you/Roger_Full_deployment/master/id_rsa.pub;
curl -L -o /etc/ssh/sshd_config https://raw.githubusercontent.com/sael-you/Roger_Full_deployment/master/config/sshd_config;
service ssh restart

#install apache2
apt -y install apache2

#install and set up fail2ban
apt -y install fail2ban
curl -L -o /etc/fail2ban/jail.local https://raw.githubusercontent.com/sael-you/Roger_Full_deployment/master/jail.local
curl -L -o /etc/fail2ban/filter.d/apache-dos.conf https://raw.githubusercontent.com/sael-you/Roger_Full_deployment/master/apache-dos.conf
service fail2ban restart

#creat website repository for further deployment
cd /var
mkdir repo
cd repo
mkdir rogersite.git
cd rogersite.git
git init --bare
cd hooks
echo '#!/bin/sh
git --work-tree=/var/www/roger.site --git-dir=/var/repo/rogersite.git checkout -f' > post-receive
chmod +x post-receive
chmod 777 -R /var/repo
git clone https://github.com/sael-you/roger_website.git /var/www/roger.site
chmod 777 -R /var/www/roger.site

#set iptables rules port/portscan
iptables -F

#Log attack
iptables -A INPUT -p tcp --tcp-flags ALL NONE -m limit --limit 3/m --limit-burst 5 -j LOG --log-prefix "Firewall> Null scan "
# Drop and blacklist for 60 seconds IP of attacker
iptables -A INPUT -p tcp --tcp-flags ALL NONE  -m recent --name blacklist_60 --set -m comment --comment "Drop/Blacklist Null scan" -j DROP
iptables   -A INPUT -p tcp ! --syn -m state --state NEW  -m comment --comment "Drop TCP connection not starting by SYN" -j DROP
# log  probable sS and full connect tcp scan
iptables -A INPUT -p tcp  -m multiport --dports 23,79,53,80,443,22 --tcp-flags ALL SYN -m limit --limit 3/m --limit-burst 5 -j LOG --log-prefix "Firewall>SYN scan trap:"
# blacklist for three minuts
iptables -A  INPUT -p tcp  -m multiport --dports 23,79,53,80,443,22 --tcp-flags ALL SYN -m recent --name blacklist_180 --set -j DROP

iptables -A INPUT -p udp  --dport 53 -m limit --limit 6/h --limit-burst 1 -m length --length 0:28 -j LOG --log-prefix "Firewall>0 length udp "
iptables -A INPUT -p udp --dport 53 -m length --length 0:28 -m comment --comment "Drop UDP packet with no content" -j DROP
#rules for ping
iptables -A INPUT  -p icmp --icmp-type echo-request -m state --state NEW,ESTABLISHED -j ACCEPT

#rules for loopback
iptables -A INPUT -i lo -j ACCEPT

#rules for incoming ssh/http/https
iptables -A INPUT -p tcp --dport 1337 -s 10.11.8.8 -j ACCEPT
iptables -A INPUT -p tcp --dport 1337 -j DROP
iptables -A INPUT  -p tcp -m multiport --dports 1337,80,443,53 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A INPUT  -p udp --dport 53 -s 10.11.8.8 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A INPUT -j DROP

#install iptables_persistent
echo iptables-persistent iptables-persistent/autosave_v4 boolean true | sudo debconf-set-selections
echo iptables-persistent iptables-persistent/autosave_v6 boolean true | sudo debconf-set-selections
apt -y install iptables-persistent
service iptables-persistent start
iptables-save > /etc/iptables/rules.v4

#set static ip mask /30
#curl -L -o /etc/netplan/50-cloud-init.yaml https://raw.githubusercontent.com/sael-you/Roger_Full_deployment/master/config/50-cloud-init.yaml;
#netplan apply;

#delete crontab
crontab -r
